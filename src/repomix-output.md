This file is a merged representation of the entire codebase, combining all repository files into a single document.
Generated by Repomix on: 2025-01-18T01:12:04.422Z

# File Summary

## Purpose
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.

## File Format
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Multiple file entries, each consisting of:
  a. A header with the file path (## File: path/to/file)
  b. The full contents of the file in a code block

## Usage Guidelines
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.

## Notes
- Some files may have been excluded based on .gitignore rules and Repomix's
  configuration.
- Binary files are not included in this packed representation. Please refer to
  the Repository Structure section for a complete list of file paths, including
  binary files.

## Additional Info

# Directory Structure
```
src/
  data/
    modDataValidator.bas
    modDBHandler.bas
    modFileSystem.bas
    README.md
  system/
    modConfigManager.bas
    modErrorHandler.bas
    modLogger.bas
    README.md
  README.md
```

# Files

## File: src/data/modDataValidator.bas
```
Attribute VB_Name = "modDataValidator"
Option Explicit

'*******************************************************************************
' モジュール: modDataValidator
' 目的：     データ入力の検証機能の提供
' 作成日：   2025/01/17
'*******************************************************************************

' 検証結果の定義
Private Type ValidationResult
    IsValid As Boolean
    ErrorMessage As String
End Type

' 一般的な検証パターン
Private Const PATTERN_EMAIL As String = "^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$"
Private Const PATTERN_DATE As String = "^\d{4}/\d{2}/\d{2}$"
Private Const PATTERN_TIME As String = "^\d{2}:\d{2}(:\d{2})?$"
Private Const PATTERN_PHONE As String = "^[0-9-()+ ]{10,}$"

'*******************************************************************************
' 目的：    必須入力の検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateRequired(ByVal value As String, _
                               ByVal fieldName As String) As ValidationResult
                               
    Dim result As ValidationResult
    
    ' 空文字列や空白文字のみの場合はエラー
    If Trim(value) = "" Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は必須項目です。"
    Else
        result.IsValid = True
    End If
    
    ValidateRequired = result
End Function

'*******************************************************************************
' 目的：    文字列の長さの検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
'           minLength - 最小長（オプション）
'           maxLength - 最大長（オプション）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateLength(ByVal value As String, _
                             ByVal fieldName As String, _
                             Optional ByVal minLength As Long = 0, _
                             Optional ByVal maxLength As Long = -1) As ValidationResult
                             
    Dim result As ValidationResult
    Dim valueLength As Long
    
    valueLength = Len(value)
    
    ' 最小長のチェック
    If valueLength < minLength Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & minLength & "文字以上で入力してください。"
        ValidateLength = result
        Exit Function
    End If
    
    ' 最大長のチェック（-1は無制限）
    If maxLength > 0 And valueLength > maxLength Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & maxLength & "文字以下で入力してください。"
        ValidateLength = result
        Exit Function
    End If
    
    result.IsValid = True
    ValidateLength = result
End Function

'*******************************************************************************
' 目的：    数値範囲の検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
'           minValue - 最小値（オプション）
'           maxValue - 最大値（オプション）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateNumberRange(ByVal value As Variant, _
                                  ByVal fieldName As String, _
                                  Optional ByVal minValue As Double = -1E+308, _
                                  Optional ByVal maxValue As Double = 1E+308) As ValidationResult
                                  
    Dim result As ValidationResult
    
    ' 数値形式の確認
    If Not IsNumeric(value) Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は数値で入力してください。"
        ValidateNumberRange = result
        Exit Function
    End If
    
    Dim numValue As Double
    numValue = CDbl(value)
    
    ' 最小値のチェック
    If numValue < minValue Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & minValue & "以上で入力してください。"
        ValidateNumberRange = result
        Exit Function
    End If
    
    ' 最大値のチェック
    If numValue > maxValue Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & maxValue & "以下で入力してください。"
        ValidateNumberRange = result
        Exit Function
    End If
    
    result.IsValid = True
    ValidateNumberRange = result
End Function

'*******************************************************************************
' 目的：    日付形式の検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
'           minDate - 最小日付（オプション）
'           maxDate - 最大日付（オプション）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateDate(ByVal value As String, _
                           ByVal fieldName As String, _
                           Optional ByVal minDate As Date, _
                           Optional ByVal maxDate As Date) As ValidationResult
                           
    Dim result As ValidationResult
    
    ' 日付形式の確認
    If Not value Like PATTERN_DATE Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "はYYYY/MM/DD形式で入力してください。"
        ValidateDate = result
        Exit Function
    End If
    
    Dim dateValue As Date
    On Error Resume Next
    dateValue = CDate(value)
    If Err.Number <> 0 Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は有効な日付を入力してください。"
        ValidateDate = result
        Exit Function
    End If
    On Error GoTo 0
    
    ' 最小日付のチェック
    If Not IsEmpty(minDate) And dateValue < minDate Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & Format(minDate, "yyyy/mm/dd") & "以降の日付を入力してください。"
        ValidateDate = result
        Exit Function
    End If
    
    ' 最大日付のチェック
    If Not IsEmpty(maxDate) And dateValue > maxDate Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は" & Format(maxDate, "yyyy/mm/dd") & "以前の日付を入力してください。"
        ValidateDate = result
        Exit Function
    End If
    
    result.IsValid = True
    ValidateDate = result
End Function

'*******************************************************************************
' 目的：    メールアドレス形式の検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateEmail(ByVal value As String, _
                            ByVal fieldName As String) As ValidationResult
                            
    Dim result As ValidationResult
    
    ' メールアドレス形式の確認
    If Not value Like PATTERN_EMAIL Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は有効なメールアドレス形式で入力してください。"
    Else
        result.IsValid = True
    End If
    
    ValidateEmail = result
End Function

'*******************************************************************************
' 目的：    電話番号形式の検証
' 引数：    value - 検証対象の値
'           fieldName - フィールド名（エラーメッセージ用）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidatePhone(ByVal value As String, _
                            ByVal fieldName As String) As ValidationResult
                            
    Dim result As ValidationResult
    
    ' 電話番号形式の確認
    If Not value Like PATTERN_PHONE Then
        result.IsValid = False
        result.ErrorMessage = fieldName & "は有効な電話番号形式で入力してください。"
    Else
        result.IsValid = True
    End If
    
    ValidatePhone = result
End Function

'*******************************************************************************
' 目的：    正規表現パターンによる検証
' 引数：    value - 検証対象の値
'           pattern - 正規表現パターン
'           fieldName - フィールド名（エラーメッセージ用）
'           errorMessage - カスタムエラーメッセージ（オプション）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidatePattern(ByVal value As String, _
                              ByVal pattern As String, _
                              ByVal fieldName As String, _
                              Optional ByVal errorMessage As String = "") As ValidationResult
                              
    Dim result As ValidationResult
    Dim regex As Object
    
    Set regex = CreateObject("VBScript.RegExp")
    With regex
        .Global = True
        .MultiLine = True
        .IgnoreCase = True
        .Pattern = pattern
    End With
    
    ' パターンマッチング
    If Not regex.Test(value) Then
        result.IsValid = False
        If errorMessage = "" Then
            result.ErrorMessage = fieldName & "は正しい形式で入力してください。"
        Else
            result.ErrorMessage = errorMessage
        End If
    Else
        result.IsValid = True
    End If
    
    ValidatePattern = result
End Function

'*******************************************************************************
' 目的：    データ型の検証
' 引数：    value - 検証対象の値
'           expectedType - 期待するデータ型（"Number", "Date", "Boolean"など）
'           fieldName - フィールド名（エラーメッセージ用）
' 戻り値：  ValidationResult
'*******************************************************************************
Public Function ValidateDataType(ByVal value As Variant, _
                               ByVal expectedType As String, _
                               ByVal fieldName As String) As ValidationResult
                               
    Dim result As ValidationResult
    
    Select Case LCase(expectedType)
        Case "number"
            result.IsValid = IsNumeric(value)
            If Not result.IsValid Then
                result.ErrorMessage = fieldName & "は数値で入力してください。"
            End If
            
        Case "date"
            result.IsValid = IsDate(value)
            If Not result.IsValid Then
                result.ErrorMessage = fieldName & "は日付形式で入力してください。"
            End If
            
        Case "boolean"
            result.IsValid = IsBoolean(value)
            If Not result.IsValid Then
                result.ErrorMessage = fieldName & "は真偽値で入力してください。"
            End If
            
        Case Else
            result.IsValid = False
            result.ErrorMessage = "未対応のデータ型です: " & expectedType
    End Select
    
    ValidateDataType = result
End Function

'*******************************************************************************
' 目的：    複数の検証結果の組み合わせ
' 引数：    results - ValidationResultの配列
' 戻り値：  ValidationResult（エラーメッセージは改行で結合）
'*******************************************************************************
Public Function CombineResults(ParamArray results() As Variant) As ValidationResult
    Dim result As ValidationResult
    Dim i As Long
    Dim messages As String
    
    result.IsValid = True
    
    For i = LBound(results) To UBound(results)
        If Not results(i).IsValid Then
            result.IsValid = False
            If messages = "" Then
                messages = results(i).ErrorMessage
            Else
                messages = messages & vbNewLine & results(i).ErrorMessage
            End If
        End If
    Next i
    
    result.ErrorMessage = messages
    CombineResults = result
End Function
```

## File: src/data/modDBHandler.bas
```
Attribute VB_Name = "modDBHandler"
Option Explicit

'*******************************************************************************
' モジュール: modDBHandler
' 目的：     データベース操作の中央管理
' 作成日：   2025/01/17
'*******************************************************************************

Private Type DBConnection
    ConnectionString As String
    Connection As Object      ' ADODB.Connection
    IsConnected As Boolean
    LastError As String
End Type

Private mConnection As DBConnection

'*******************************************************************************
' 目的：    データベース接続の初期化
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub Initialize()
    On Error GoTo ErrorHandler
    
    ' 設定からデータベース接続情報を取得
    Dim server As String
    Dim database As String
    Dim username As String
    Dim password As String
    
    server = modConfigManager.GetValue("database", "server", "")
    database = modConfigManager.GetValue("database", "database", "")
    username = modConfigManager.GetValue("database", "username", "")
    password = modConfigManager.GetValue("database", "password", "")
    
    ' 接続文字列の構築
    mConnection.ConnectionString = "Provider=SQLOLEDB;" & _
                                 "Data Source=" & server & ";" & _
                                 "Initial Catalog=" & database & ";" & _
                                 "User ID=" & username & ";" & _
                                 "Password=" & password
    
    modLogger.Info "データベース設定を初期化しました。", "DBHandler.Initialize"
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.Initialize", _
                               etDatabase
End Sub

'*******************************************************************************
' 目的：    データベースへの接続
' 引数：    なし
' 戻り値：  成功時 True
'*******************************************************************************
Public Function Connect() As Boolean
    On Error GoTo ErrorHandler
    
    ' 既に接続されている場合は何もしない
    If mConnection.IsConnected Then
        Connect = True
        Exit Function
    End If
    
    ' 接続オブジェクトの作成と接続
    Set mConnection.Connection = CreateObject("ADODB.Connection")
    With mConnection.Connection
        .ConnectionString = mConnection.ConnectionString
        .ConnectionTimeout = 30
        .Open
    End With
    
    mConnection.IsConnected = True
    Connect = True
    
    modLogger.Info "データベースに接続しました。", "DBHandler.Connect"
    Exit Function
    
ErrorHandler:
    mConnection.LastError = Err.Description
    mConnection.IsConnected = False
    Connect = False
    
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.Connect", _
                               etDatabase
End Function

'*******************************************************************************
' 目的：    データベース接続の切断
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub Disconnect()
    On Error GoTo ErrorHandler
    
    If mConnection.IsConnected Then
        mConnection.Connection.Close
        Set mConnection.Connection = Nothing
        mConnection.IsConnected = False
        modLogger.Info "データベース接続を切断しました。", "DBHandler.Disconnect"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.Disconnect", _
                               etDatabase
End Sub

'*******************************************************************************
' 目的：    SQLクエリの実行（読み取り）
' 引数：    sql - 実行するSQL文
'           params - SQLパラメータ（オプション）
' 戻り値：  レコードセット
'*******************************************************************************
Public Function ExecuteQuery(ByVal sql As String, _
                           Optional ByRef params As Variant) As Object
    On Error GoTo ErrorHandler
    
    Dim cmd As Object    ' ADODB.Command
    Dim rs As Object     ' ADODB.Recordset
    
    ' 接続確認
    If Not mConnection.IsConnected Then
        If Not Connect Then
            Exit Function
        End If
    End If
    
    ' コマンドオブジェクトの作成
    Set cmd = CreateObject("ADODB.Command")
    With cmd
        Set .ActiveConnection = mConnection.Connection
        .CommandText = sql
        .CommandType = 1  ' adCmdText
        
        ' パラメータの設定
        If Not IsMissing(params) Then
            If IsArray(params) Then
                Dim i As Long
                For i = LBound(params) To UBound(params)
                    .Parameters.Append .CreateParameter("p" & i, _
                                                     GetParamType(params(i)), _
                                                     1, _  ' adParamInput
                                                     Len(params(i)), _
                                                     params(i))
                Next i
            End If
        End If
    End With
    
    ' クエリの実行
    Set rs = cmd.Execute
    Set ExecuteQuery = rs
    
    modLogger.Debug "SQLクエリを実行しました: " & sql, "DBHandler.ExecuteQuery"
    Exit Function
    
ErrorHandler:
    mConnection.LastError = Err.Description
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.ExecuteQuery", _
                               etDatabase, _
                               "SQL: " & sql
End Function

'*******************************************************************************
' 目的：    SQLコマンドの実行（更新系）
' 引数：    sql - 実行するSQL文
'           params - SQLパラメータ（オプション）
' 戻り値：  影響を受けた行数
'*******************************************************************************
Public Function ExecuteCommand(ByVal sql As String, _
                             Optional ByRef params As Variant) As Long
    On Error GoTo ErrorHandler
    
    Dim cmd As Object    ' ADODB.Command
    Dim affectedRows As Long
    
    ' 接続確認
    If Not mConnection.IsConnected Then
        If Not Connect Then
            Exit Function
        End If
    End If
    
    ' コマンドオブジェクトの作成
    Set cmd = CreateObject("ADODB.Command")
    With cmd
        Set .ActiveConnection = mConnection.Connection
        .CommandText = sql
        .CommandType = 1  ' adCmdText
        
        ' パラメータの設定
        If Not IsMissing(params) Then
            If IsArray(params) Then
                Dim i As Long
                For i = LBound(params) To UBound(params)
                    .Parameters.Append .CreateParameter("p" & i, _
                                                     GetParamType(params(i)), _
                                                     1, _  ' adParamInput
                                                     Len(params(i)), _
                                                     params(i))
                Next i
            End If
        End If
    End With
    
    ' コマンドの実行
    affectedRows = cmd.Execute
    ExecuteCommand = affectedRows
    
    modLogger.Debug "SQLコマンドを実行しました: " & sql & _
                   " (影響行数: " & affectedRows & ")", _
                   "DBHandler.ExecuteCommand"
    Exit Function
    
ErrorHandler:
    mConnection.LastError = Err.Description
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.ExecuteCommand", _
                               etDatabase, _
                               "SQL: " & sql
End Function

'*******************************************************************************
' 目的：    トランザクションの開始
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub BeginTransaction()
    On Error GoTo ErrorHandler
    
    If mConnection.IsConnected Then
        mConnection.Connection.BeginTrans
        modLogger.Debug "トランザクションを開始しました。", "DBHandler.BeginTransaction"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.BeginTransaction", _
                               etDatabase
End Sub

'*******************************************************************************
' 目的：    トランザクションのコミット
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub CommitTransaction()
    On Error GoTo ErrorHandler
    
    If mConnection.IsConnected Then
        mConnection.Connection.CommitTrans
        modLogger.Debug "トランザクションをコミットしました。", "DBHandler.CommitTransaction"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.CommitTransaction", _
                               etDatabase
End Sub

'*******************************************************************************
' 目的：    トランザクションのロールバック
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub RollbackTransaction()
    On Error GoTo ErrorHandler
    
    If mConnection.IsConnected Then
        mConnection.Connection.RollbackTrans
        modLogger.Debug "トランザクションをロールバックしました。", "DBHandler.RollbackTransaction"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "DBHandler.RollbackTransaction", _
                               etDatabase
End Sub

'*******************************************************************************
' 目的：    最後のエラーメッセージの取得
' 引数：    なし
' 戻り値：  エラーメッセージ
'*******************************************************************************
Public Function GetLastError() As String
    GetLastError = mConnection.LastError
End Function

'*******************************************************************************
' 目的：    接続状態の確認
' 引数：    なし
' 戻り値：  接続されている場合True
'*******************************************************************************
Public Function IsConnected() As Boolean
    IsConnected = mConnection.IsConnected
End Function

'*******************************************************************************
' 目的：    パラメータの型を判定
' 引数：    value - パラメータ値
' 戻り値：  ADODBのパラメータ型
'*******************************************************************************
Private Function GetParamType(ByVal value As Variant) As Integer
    ' ADODBのデータ型定数
    ' adEmpty = 0, adSmallInt = 2, adInteger = 3, adSingle = 4, adDouble = 5,
    ' adCurrency = 6, adDate = 7, adBSTR = 8, adIDispatch = 9, adError = 10,
    ' adBoolean = 11, adVariant = 12, adIUnknown = 13, adDecimal = 14,
    ' adTinyInt = 16, adUnsignedTinyInt = 17, adUnsignedSmallInt = 18,
    ' adUnsignedInt = 19, adBigInt = 20, adUnsignedBigInt = 21, adVarChar = 200
    
    Select Case VarType(value)
        Case vbInteger
            GetParamType = 3    ' adInteger
        Case vbLong
            GetParamType = 3    ' adInteger
        Case vbSingle
            GetParamType = 4    ' adSingle
        Case vbDouble
            GetParamType = 5    ' adDouble
        Case vbCurrency
            GetParamType = 6    ' adCurrency
        Case vbDate
            GetParamType = 7    ' adDate
        Case vbString
            GetParamType = 200  ' adVarChar
        Case vbBoolean
            GetParamType = 11   ' adBoolean
        Case Else
            GetParamType = 12   ' adVariant
    End Select
End Function
```

## File: src/data/modFileSystem.bas
```
Attribute VB_Name = "modFileSystem"
Option Explicit

'*******************************************************************************
' モジュール: modFileSystem
' 目的：     ファイルシステム操作の中央管理
' 作成日：   2025/01/17
'*******************************************************************************

' ファイルシステムオブジェクト
Private mFSO As Object  ' Scripting.FileSystemObject

'*******************************************************************************
' 目的：    モジュールの初期化
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub Initialize()
    On Error GoTo ErrorHandler
    
    ' FileSystemObjectの作成
    Set mFSO = CreateObject("Scripting.FileSystemObject")
    modLogger.Info "ファイルシステムモジュールを初期化しました。", "FileSystem.Initialize"
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.Initialize", _
                               etFileSystem
End Sub

'*******************************************************************************
' 目的：    ファイルの存在確認
' 引数：    filePath - ファイルパス
' 戻り値：  存在する場合True
'*******************************************************************************
Public Function FileExists(ByVal filePath As String) As Boolean
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    FileExists = mFSO.FileExists(filePath)
    Exit Function
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.FileExists", _
                               etFileSystem, _
                               "Path: " & filePath
End Function

'*******************************************************************************
' 目的：    ディレクトリの存在確認
' 引数：    dirPath - ディレクトリパス
' 戻り値：  存在する場合True
'*******************************************************************************
Public Function DirectoryExists(ByVal dirPath As String) As Boolean
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    DirectoryExists = mFSO.FolderExists(dirPath)
    Exit Function
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.DirectoryExists", _
                               etFileSystem, _
                               "Path: " & dirPath
End Function

'*******************************************************************************
' 目的：    ファイルの読み込み
' 引数：    filePath - ファイルパス
' 戻り値：  ファイルの内容
'*******************************************************************************
Public Function ReadFile(ByVal filePath As String) As String
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    Dim textStream As Object
    
    ' ファイルが存在しない場合はエラー
    If Not FileExists(filePath) Then
        Err.Raise vbObjectError + 1000, "FileSystem.ReadFile", _
                  "指定されたファイルが存在しません: " & filePath
    End If
    
    ' ファイルを読み込み
    Set textStream = mFSO.OpenTextFile(filePath, 1) ' ForReading = 1
    ReadFile = textStream.ReadAll
    textStream.Close
    
    modLogger.Debug "ファイルを読み込みました: " & filePath, "FileSystem.ReadFile"
    Exit Function
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.ReadFile", _
                               etFileSystem, _
                               "Path: " & filePath
End Function

'*******************************************************************************
' 目的：    ファイルの書き込み
' 引数：    filePath - ファイルパス
'           content - 書き込む内容
'           append - 追記モード（オプション）
' 戻り値：  なし
'*******************************************************************************
Public Sub WriteFile(ByVal filePath As String, _
                    ByVal content As String, _
                    Optional ByVal append As Boolean = False)
                    
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    Dim textStream As Object
    Dim mode As Integer
    
    ' 書き込みモードの設定
    If append Then
        mode = 8  ' ForAppending = 8
    Else
        mode = 2  ' ForWriting = 2
    End If
    
    ' ディレクトリが存在しない場合は作成
    Dim parentPath As String
    parentPath = mFSO.GetParentFolderName(filePath)
    If parentPath <> "" And Not DirectoryExists(parentPath) Then
        CreateDirectory parentPath
    End If
    
    ' ファイルに書き込み
    Set textStream = mFSO.OpenTextFile(filePath, mode, True)
    textStream.Write content
    textStream.Close
    
    modLogger.Debug "ファイルを書き込みました: " & filePath, "FileSystem.WriteFile"
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.WriteFile", _
                               etFileSystem, _
                               "Path: " & filePath
End Sub

'*******************************************************************************
' 目的：    ディレクトリの作成
' 引数：    dirPath - ディレクトリパス
' 戻り値：  なし
'*******************************************************************************
Public Sub CreateDirectory(ByVal dirPath As String)
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    ' ディレクトリが存在しない場合のみ作成
    If Not DirectoryExists(dirPath) Then
        mFSO.CreateFolder dirPath
        modLogger.Debug "ディレクトリを作成しました: " & dirPath, "FileSystem.CreateDirectory"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.CreateDirectory", _
                               etFileSystem, _
                               "Path: " & dirPath
End Sub

'*******************************************************************************
' 目的：    ファイルのコピー
' 引数：    sourcePath - コピー元パス
'           destPath - コピー先パス
'           overwrite - 上書き（オプション）
' 戻り値：  なし
'*******************************************************************************
Public Sub CopyFile(ByVal sourcePath As String, _
                   ByVal destPath As String, _
                   Optional ByVal overwrite As Boolean = False)
                   
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    ' コピー元ファイルの存在確認
    If Not FileExists(sourcePath) Then
        Err.Raise vbObjectError + 1001, "FileSystem.CopyFile", _
                  "コピー元ファイルが存在しません: " & sourcePath
    End If
    
    ' コピー先のディレクトリが存在しない場合は作成
    Dim destDir As String
    destDir = mFSO.GetParentFolderName(destPath)
    If destDir <> "" And Not DirectoryExists(destDir) Then
        CreateDirectory destDir
    End If
    
    ' ファイルをコピー
    mFSO.CopyFile sourcePath, destPath, overwrite
    
    modLogger.Debug "ファイルをコピーしました: " & sourcePath & " -> " & destPath, _
                   "FileSystem.CopyFile"
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.CopyFile", _
                               etFileSystem, _
                               "Source: " & sourcePath & ", Dest: " & destPath
End Sub

'*******************************************************************************
' 目的：    ファイルの移動
' 引数：    sourcePath - 移動元パス
'           destPath - 移動先パス
' 戻り値：  なし
'*******************************************************************************
Public Sub MoveFile(ByVal sourcePath As String, ByVal destPath As String)
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    ' 移動元ファイルの存在確認
    If Not FileExists(sourcePath) Then
        Err.Raise vbObjectError + 1002, "FileSystem.MoveFile", _
                  "移動元ファイルが存在しません: " & sourcePath
    End If
    
    ' 移動先のディレクトリが存在しない場合は作成
    Dim destDir As String
    destDir = mFSO.GetParentFolderName(destPath)
    If destDir <> "" And Not DirectoryExists(destDir) Then
        CreateDirectory destDir
    End If
    
    ' ファイルを移動
    mFSO.MoveFile sourcePath, destPath
    
    modLogger.Debug "ファイルを移動しました: " & sourcePath & " -> " & destPath, _
                   "FileSystem.MoveFile"
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.MoveFile", _
                               etFileSystem, _
                               "Source: " & sourcePath & ", Dest: " & destPath
End Sub

'*******************************************************************************
' 目的：    ファイルの削除
' 引数：    filePath - ファイルパス
' 戻り値：  なし
'*******************************************************************************
Public Sub DeleteFile(ByVal filePath As String)
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    ' ファイルが存在する場合のみ削除
    If FileExists(filePath) Then
        mFSO.DeleteFile filePath, False ' Force = False
        modLogger.Debug "ファイルを削除しました: " & filePath, "FileSystem.DeleteFile"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.DeleteFile", _
                               etFileSystem, _
                               "Path: " & filePath
End Sub

'*******************************************************************************
' 目的：    ディレクトリの削除
' 引数：    dirPath - ディレクトリパス
'           recursive - サブディレクトリも含めて削除
' 戻り値：  なし
'*******************************************************************************
Public Sub DeleteDirectory(ByVal dirPath As String, _
                         Optional ByVal recursive As Boolean = False)
                         
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    ' ディレクトリが存在する場合のみ削除
    If DirectoryExists(dirPath) Then
        mFSO.DeleteFolder dirPath, False ' Force = False
        modLogger.Debug "ディレクトリを削除しました: " & dirPath, "FileSystem.DeleteDirectory"
    End If
    
    Exit Sub
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.DeleteDirectory", _
                               etFileSystem, _
                               "Path: " & dirPath
End Sub

'*******************************************************************************
' 目的：    ファイル一覧の取得
' 引数：    dirPath - ディレクトリパス
'           pattern - 検索パターン（オプション）
' 戻り値：  ファイル名の配列
'*******************************************************************************
Public Function GetFiles(ByVal dirPath As String, _
                        Optional ByVal pattern As String = "*.*") As Variant
                        
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    Dim folder As Object
    Dim file As Object
    Dim fileList() As String
    Dim count As Long
    
    ' ディレクトリの存在確認
    If Not DirectoryExists(dirPath) Then
        Err.Raise vbObjectError + 1003, "FileSystem.GetFiles", _
                  "指定されたディレクトリが存在しません: " & dirPath
    End If
    
    ' ディレクトリ内のファイルを列挙
    Set folder = mFSO.GetFolder(dirPath)
    ReDim fileList(0 To folder.Files.Count - 1)
    
    count = 0
    For Each file In folder.Files
        ' パターンに一致するファイルのみ追加
        If file.Name Like pattern Then
            fileList(count) = file.Name
            count = count + 1
        End If
    Next file
    
    ' 配列のサイズを実際のファイル数に調整
    If count > 0 Then
        ReDim Preserve fileList(0 To count - 1)
        GetFiles = fileList
    Else
        GetFiles = Array()
    End If
    
    modLogger.Debug "ファイル一覧を取得しました: " & dirPath & " (" & count & "件)", _
                   "FileSystem.GetFiles"
    Exit Function
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.GetFiles", _
                               etFileSystem, _
                               "Path: " & dirPath
End Function

'*******************************************************************************
' 目的：    ファイル情報の取得
' 引数：    filePath - ファイルパス
' 戻り値：  Dictionary（サイズ、作成日時、更新日時など）
'*******************************************************************************
Public Function GetFileInfo(ByVal filePath As String) As Object
    On Error GoTo ErrorHandler
    
    If mFSO Is Nothing Then Initialize
    
    Dim file As Object
    Dim info As Object
    
    ' ファイルの存在確認
    If Not FileExists(filePath) Then
        Err.Raise vbObjectError + 1004, "FileSystem.GetFileInfo", _
                  "指定されたファイルが存在しません: " & filePath
    End If
    
    ' ファイル情報を取得
    Set file = mFSO.GetFile(filePath)
    Set info = CreateObject("Scripting.Dictionary")
    
    With file
        info.Add "Name", .Name
        info.Add "Path", .Path
        info.Add "Size", .Size
        info.Add "DateCreated", .DateCreated
        info.Add "DateLastModified", .DateLastModified
        info.Add "DateLastAccessed", .DateLastAccessed
        info.Add "Type", .Type
    End With
    
    Set GetFileInfo = info
    
    modLogger.Debug "ファイル情報を取得しました: " & filePath, "FileSystem.GetFileInfo"
    Exit Function
    
ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "FileSystem.GetFileInfo", _
                               etFileSystem, _
                               "Path: " & filePath
End Function
```

## File: src/data/README.md
```markdown
# データ層

このディレクトリには、データアクセスと検証を担当するモジュールが含まれています。

## モジュール構成

### modDBHandler.bas
データベース操作の中央管理システム。ADO（ActiveX Data Objects）を使用したデータベースアクセスを提供します。

```vb
' データベース接続と操作の例
Public Sub ProcessDatabaseOperation()
    ' 初期化と接続
    modDBHandler.Initialize
    If modDBHandler.Connect Then
        ' トランザクション開始
        modDBHandler.BeginTransaction
        
        On Error GoTo ErrorHandler
        
        ' データの取得
        Dim rs As Object
        Set rs = modDBHandler.ExecuteQuery("SELECT * FROM Users WHERE Active = ?", Array(True))
        
        ' データの更新
        Dim affected As Long
        affected = modDBHandler.ExecuteCommand("UPDATE Users SET LastLogin = ? WHERE UserID = ?", _
                                             Array(Now, 123))
        
        ' トランザクションのコミット
        modDBHandler.CommitTransaction
        Exit Sub
        
    ErrorHandler:
        ' エラー発生時はロールバック
        modDBHandler.RollbackTransaction
        modErrorHandler.HandleError Err.Number, Err.Description, "ProcessDatabaseOperation", etDatabase
    End If
End Sub
```

### modFileSystem.bas
ファイルシステム操作の中央管理システム。ファイルの読み書き、コピー、移動などの操作を提供します。

```vb
' ファイル操作の例
Public Sub ProcessFileOperation()
    ' ファイルの読み書き
    If modFileSystem.FileExists("data.txt") Then
        Dim content As String
        content = modFileSystem.ReadFile("data.txt")
        modFileSystem.WriteFile "backup.txt", content
    End If
    
    ' ディレクトリ操作
    If Not modFileSystem.DirectoryExists("logs") Then
        modFileSystem.CreateDirectory "logs"
    End If
    
    ' ファイル一覧の取得
    Dim files As Variant
    files = modFileSystem.GetFiles("logs", "*.log")
    
    ' ファイル情報の取得
    Dim fileInfo As Object
    Set fileInfo = modFileSystem.GetFileInfo("data.txt")
    Debug.Print "File Size: " & fileInfo("Size")
End Sub
```

### modDataValidator.bas
データ入力の検証機能を提供します。様々な形式のデータ検証に対応しています。

```vb
' データ検証の例
Public Function ValidateUserInput(ByVal userName As String, _
                                ByVal email As String, _
                                ByVal age As Variant) As Boolean
                                
    Dim result As ValidationResult
    
    ' 必須入力の検証
    result = modDataValidator.ValidateRequired(userName, "ユーザー名")
    If Not result.IsValid Then
        MsgBox result.ErrorMessage
        Exit Function
    End If
    
    ' メールアドレス形式の検証
    result = modDataValidator.ValidateEmail(email, "メールアドレス")
    If Not result.IsValid Then
        MsgBox result.ErrorMessage
        Exit Function
    End If
    
    ' 数値範囲の検証
    result = modDataValidator.ValidateNumberRange(age, "年齢", 0, 120)
    If Not result.IsValid Then
        MsgBox result.ErrorMessage
        Exit Function
    End If
    
    ValidateUserInput = True
End Function
```

## モジュール間の連携

1. エラー処理とログ記録
```vb
Private Sub HandleDataOperation()
    On Error GoTo ErrorHandler
    
    ' データベース操作
    modDBHandler.BeginTransaction
    
    ' ファイル操作
    Dim data As String
    data = modFileSystem.ReadFile("input.txt")
    
    ' データ検証
    Dim result As ValidationResult
    result = modDataValidator.ValidateRequired(data, "入力データ")
    
    If result.IsValid Then
        ' 検証OKならデータベースに保存
        modDBHandler.ExecuteCommand "INSERT INTO Data (Content) VALUES (?)", Array(data)
        modDBHandler.CommitTransaction
    Else
        modDBHandler.RollbackTransaction
    End If
    
    Exit Sub
    
ErrorHandler:
    modDBHandler.RollbackTransaction
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "HandleDataOperation", _
                               etDatabase
End Sub
```

2. 設定に基づくデータベース接続
```vb
Public Sub InitializeDataLayer()
    ' 設定からデータベース接続情報を取得
    Dim server As String
    Dim database As String
    server = modConfigManager.GetValue("database", "server")
    database = modConfigManager.GetValue("database", "database")
    
    ' データベース接続の初期化
    modDBHandler.Initialize
    
    ' ログレベルの設定
    Dim logLevel As String
    logLevel = modConfigManager.GetValue("logging", "level")
    modLogger.Configure "", logLevel
End Sub
```

## エラーコード体系

データ層で使用するエラーコードの範囲：

- vbObjectError + 1000: ファイルが存在しない
- vbObjectError + 1001: コピー元ファイルが存在しない
- vbObjectError + 1002: 移動元ファイルが存在しない
- vbObjectError + 1003: ディレクトリが存在しない
- vbObjectError + 1004: ファイル情報の取得に失敗

## セキュリティ考慮事項

1. データベースセキュリティ
   - パラメータ化クエリの使用（SQLインジェクション対策）
   - 接続情報の暗号化
   - 最小権限の原則

2. ファイルシステムセキュリティ
   - アクセス権限の確認
   - パスのバリデーション
   - セキュアな一時ファイル処理

3. 入力データのセキュリティ
   - 不正な入力値の検証
   - エスケープ処理
   - 文字エンコーディングの制御

## パフォーマンス最適化

1. データベース操作
   - コネクションプーリング
   - バッチ処理の活用
   - インデックスの適切な使用

2. ファイル操作
   - バッファリングの活用
   - 非同期処理の検討
   - ファイルハンドルの適切な管理

3. データ検証
   - キャッシュの活用
   - 正規表現の最適化
   - バリデーションの順序の最適化

## 今後の拡張計画

1. 新機能の追加
   - NoSQLデータベースサポート
   - クラウドストレージ連携
   - データ暗号化機能

2. パフォーマンス改善
   - 非同期処理の実装
   - キャッシュ機構の強化
   - バッチ処理の最適化

3. セキュリティ強化
   - 監査ログの実装
   - アクセス制御の強化
   - 暗号化機能の拡充
```

## File: src/system/modConfigManager.bas
```
Attribute VB_Name = "modConfigManager"
Option Explicit

'*******************************************************************************
' モジュール: modConfigManager
' 目的：     アプリケーション設定の中央管理
' 作成日：   2025/01/17
'*******************************************************************************

' 設定ファイルのデフォルトパス
Private Const DEFAULT_CONFIG_PATH As String = "config/settings.json"

' 設定のキャッシュ
Private mConfigCache As Object
Private mConfigPath As String
Private mIsInitialized As Boolean

'*******************************************************************************
' 目的：    モジュールの初期化
' 引数：    configPath - 設定ファイルのパス（オプション）
' 戻り値：  なし
'*******************************************************************************
Public Sub Initialize(Optional ByVal configPath As String = "")
    If configPath = "" Then
        mConfigPath = DEFAULT_CONFIG_PATH
    Else
        mConfigPath = configPath
    End If
    
    ' 設定の読み込み
    LoadConfiguration
    mIsInitialized = True
End Sub

'*******************************************************************************
' 目的：    設定の読み込み
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Private Sub LoadConfiguration()
    On Error GoTo ErrorHandler
    
    Dim fso As Object
    Dim jsonFile As Object
    Dim jsonText As String
    Dim scriptControl As Object
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 設定ファイルが存在しない場合は、デフォルト設定を作成
    If Not fso.FileExists(mConfigPath) Then
        CreateDefaultConfig
    End If
    
    ' JSONファイルの読み込み
    Set jsonFile = fso.OpenTextFile(mConfigPath, 1)
    jsonText = jsonFile.ReadAll
    jsonFile.Close
    
    ' JSONのパース
    Set scriptControl = CreateObject("MSScriptControl.ScriptControl")
    scriptControl.Language = "JScript"
    Set mConfigCache = scriptControl.Eval("(" & jsonText & ")")
    
    Exit Sub

ErrorHandler:
    Err.Raise vbObjectError + 513, "modConfigManager", _
              "設定ファイルの読み込みに失敗しました: " & Err.Description
End Sub

'*******************************************************************************
' 目的：    デフォルト設定の作成
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Private Sub CreateDefaultConfig()
    On Error GoTo ErrorHandler
    
    Dim fso As Object
    Dim jsonFile As Object
    Dim defaultConfig As String
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' デフォルト設定の定義
    defaultConfig = "{ " & _
        """logging"": { " & _
            """level"": ""INFO"", " & _
            """path"": ""logs/app.log"", " & _
            """maxSize"": 5242880, " & _
            """rotateCount"": 5 " & _
        "}, " & _
        """database"": { " & _
            """server"": """", " & _
            """database"": """", " & _
            """username"": """", " & _
            """password"": """" " & _
        "}, " & _
        """security"": { " & _
            """encryptionKey"": """", " & _
            """sessionTimeout"": 30 " & _
        "}, " & _
        """ui"": { " & _
            """theme"": ""default"", " & _
            """language"": ""ja"" " & _
        "} " & _
    "}"
    
    ' ディレクトリが存在しない場合は作成
    If Not fso.FolderExists(fso.GetParentFolderName(mConfigPath)) Then
        fso.CreateFolder fso.GetParentFolderName(mConfigPath)
    End If
    
    ' 設定ファイルの作成
    Set jsonFile = fso.CreateTextFile(mConfigPath, True)
    jsonFile.Write defaultConfig
    jsonFile.Close
    
    Exit Sub

ErrorHandler:
    Err.Raise vbObjectError + 514, "modConfigManager", _
              "デフォルト設定の作成に失敗しました: " & Err.Description
End Sub

'*******************************************************************************
' 目的：    設定値の取得
' 引数：    section - セクション名
'           key - キー名
'           defaultValue - デフォルト値（オプション）
' 戻り値：  設定値
'*******************************************************************************
Public Function GetValue(ByVal section As String, _
                        ByVal key As String, _
                        Optional ByVal defaultValue As Variant = Null) As Variant
    
    On Error GoTo ErrorHandler
    
    ' 初期化確認
    If Not mIsInitialized Then Initialize
    
    ' 設定値の取得
    If IsObject(mConfigCache(section)) Then
        If IsEmpty(mConfigCache(section)(key)) Then
            GetValue = defaultValue
        Else
            GetValue = mConfigCache(section)(key)
        End If
    Else
        GetValue = defaultValue
    End If
    
    Exit Function

ErrorHandler:
    GetValue = defaultValue
End Function

'*******************************************************************************
' 目的：    設定値の設定
' 引数：    section - セクション名
'           key - キー名
'           value - 設定値
' 戻り値：  なし
'*******************************************************************************
Public Sub SetValue(ByVal section As String, _
                   ByVal key As String, _
                   ByVal value As Variant)
                   
    On Error GoTo ErrorHandler
    
    ' 初期化確認
    If Not mIsInitialized Then Initialize
    
    ' 設定値の更新
    If IsObject(mConfigCache(section)) Then
        mConfigCache(section)(key) = value
    Else
        Err.Raise vbObjectError + 515, "modConfigManager", _
                  "無効なセクション名です: " & section
    End If
    
    ' 設定の保存
    SaveConfiguration
    
    Exit Sub

ErrorHandler:
    Err.Raise vbObjectError + 516, "modConfigManager", _
              "設定値の更新に失敗しました: " & Err.Description
End Sub

'*******************************************************************************
' 目的：    設定の保存
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Private Sub SaveConfiguration()
    On Error GoTo ErrorHandler
    
    Dim fso As Object
    Dim jsonFile As Object
    Dim jsonText As String
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 設定をJSONに変換
    jsonText = ConvertToJson(mConfigCache)
    
    ' ファイルに保存
    Set jsonFile = fso.CreateTextFile(mConfigPath, True)
    jsonFile.Write jsonText
    jsonFile.Close
    
    Exit Sub

ErrorHandler:
    Err.Raise vbObjectError + 517, "modConfigManager", _
              "設定の保存に失敗しました: " & Err.Description
End Sub

'*******************************************************************************
' 目的：    オブジェクトをJSON形式に変換
' 引数：    obj - 変換対象のオブジェクト
' 戻り値：  JSON文字列
'*******************************************************************************
Private Function ConvertToJson(ByVal obj As Object) As String
    On Error Resume Next
    
    Dim key As Variant
    Dim item As Variant
    Dim result As String
    Dim isFirst As Boolean
    
    result = "{"
    isFirst = True
    
    ' オブジェクトのプロパティをループ
    For Each key In obj
        If Not isFirst Then
            result = result & ", "
        End If
        
        result = result & """" & key & """: "
        
        ' 値の型に応じた処理
        If IsObject(obj(key)) Then
            result = result & ConvertToJson(obj(key))
        ElseIf IsNull(obj(key)) Then
            result = result & "null"
        ElseIf IsNumeric(obj(key)) Then
            result = result & CStr(obj(key))
        Else
            result = result & """" & Replace(obj(key), """", "\""") & """"
        End If
        
        isFirst = False
    Next key
    
    result = result & "}"
    ConvertToJson = result
End Function

'*******************************************************************************
' 目的：    セクションの存在確認
' 引数：    section - セクション名
' 戻り値：  存在する場合はTrue
'*******************************************************************************
Public Function HasSection(ByVal section As String) As Boolean
    On Error Resume Next
    
    ' 初期化確認
    If Not mIsInitialized Then Initialize
    
    HasSection = IsObject(mConfigCache(section))
End Function

'*******************************************************************************
' 目的：    キーの存在確認
' 引数：    section - セクション名
'           key - キー名
' 戻り値：  存在する場合はTrue
'*******************************************************************************
Public Function HasKey(ByVal section As String, ByVal key As String) As Boolean
    On Error Resume Next
    
    ' 初期化確認
    If Not mIsInitialized Then Initialize
    
    If HasSection(section) Then
        HasKey = Not IsEmpty(mConfigCache(section)(key))
    Else
        HasKey = False
    End If
End Function
```

## File: src/system/modErrorHandler.bas
```
Attribute VB_Name = "modErrorHandler"
Option Explicit

'*******************************************************************************
' モジュール: modErrorHandler
' 目的：     エラーハンドリングの中央管理システム
' 作成日：   2025/01/17
'*******************************************************************************

' エラー種別を定義
Public Enum ErrorType
    etDatabase = 1
    etFileSystem = 2
    etValidation = 3
    etSecurity = 4
    etBusiness = 5
    etUI = 6
End Enum

' エラー情報を格納する型
Private Type ErrorInfo
    Number As Long
    Description As String
    Source As String
    ErrorType As ErrorType
    Timestamp As Date
    AdditionalInfo As String
End Type

' エラーログの設定
Private Const ERROR_LOG_PATH As String = "errors.log"
Private Const MAX_LOG_SIZE As Long = 1048576 ' 1MB

'*******************************************************************************
' 目的：    エラーを処理し、ログに記録する
' 引数：    errNumber - エラー番号
'           errDesc - エラーの説明
'           errSource - エラーの発生源
'           errType - エラーの種別
'           additionalInfo - 追加情報（オプション）
' 戻り値：  なし
'*******************************************************************************
Public Sub HandleError(ByVal errNumber As Long, _
                      ByVal errDesc As String, _
                      ByVal errSource As String, _
                      ByVal errType As ErrorType, _
                      Optional ByVal additionalInfo As String = "")
    
    Dim errorInfo As ErrorInfo
    
    ' エラー情報を設定
    With errorInfo
        .Number = errNumber
        .Description = errDesc
        .Source = errSource
        .ErrorType = errType
        .Timestamp = Now
        .AdditionalInfo = additionalInfo
    End With
    
    ' エラーをログに記録
    LogError errorInfo
    
    ' エラー種別に応じた処理
    Select Case errType
        Case etDatabase
            HandleDatabaseError errorInfo
        Case etFileSystem
            HandleFileSystemError errorInfo
        Case etSecurity
            HandleSecurityError errorInfo
        Case Else
            HandleGeneralError errorInfo
    End Select
End Sub

'*******************************************************************************
' 目的：    エラー情報をログファイルに記録する
' 引数：    errorInfo - エラー情報
' 戻り値：  なし
'*******************************************************************************
Private Sub LogError(ByRef errorInfo As ErrorInfo)
    On Error Resume Next
    
    Dim fileNum As Integer
    Dim logEntry As String
    
    ' ログエントリの作成
    logEntry = Format(errorInfo.Timestamp, "yyyy-mm-dd hh:mm:ss") & vbTab & _
               errorInfo.Number & vbTab & _
               errorInfo.Source & vbTab & _
               GetErrorTypeName(errorInfo.ErrorType) & vbTab & _
               errorInfo.Description & vbTab & _
               errorInfo.AdditionalInfo
               
    ' ログファイルへの書き込み
    fileNum = FreeFile
    Open ERROR_LOG_PATH For Append As fileNum
    Print #fileNum, logEntry
    Close fileNum
End Sub

'*******************************************************************************
' 目的：    エラー種別の名称を取得する
' 引数：    errType - エラー種別
' 戻り値：  エラー種別の文字列表現
'*******************************************************************************
Private Function GetErrorTypeName(ByVal errType As ErrorType) As String
    Select Case errType
        Case etDatabase
            GetErrorTypeName = "Database"
        Case etFileSystem
            GetErrorTypeName = "FileSystem"
        Case etValidation
            GetErrorTypeName = "Validation"
        Case etSecurity
            GetErrorTypeName = "Security"
        Case etBusiness
            GetErrorTypeName = "Business"
        Case etUI
            GetErrorTypeName = "UI"
        Case Else
            GetErrorTypeName = "Unknown"
    End Select
End Function

'*******************************************************************************
' 目的：    データベースエラーの特別処理
' 引数：    errorInfo - エラー情報
' 戻り値：  なし
'*******************************************************************************
Private Sub HandleDatabaseError(ByRef errorInfo As ErrorInfo)
    ' データベース特有のエラー処理をここに実装
    MsgBox "データベースエラーが発生しました。" & vbNewLine & _
           "エラー: " & errorInfo.Description, _
           vbCritical + vbOKOnly, _
           "データベースエラー"
End Sub

'*******************************************************************************
' 目的：    ファイルシステムエラーの特別処理
' 引数：    errorInfo - エラー情報
' 戻り値：  なし
'*******************************************************************************
Private Sub HandleFileSystemError(ByRef errorInfo As ErrorInfo)
    ' ファイルシステム特有のエラー処理をここに実装
    MsgBox "ファイルシステムエラーが発生しました。" & vbNewLine & _
           "エラー: " & errorInfo.Description, _
           vbCritical + vbOKOnly, _
           "ファイルシステムエラー"
End Sub

'*******************************************************************************
' 目的：    セキュリティエラーの特別処理
' 引数：    errorInfo - エラー情報
' 戻り値：  なし
'*******************************************************************************
Private Sub HandleSecurityError(ByRef errorInfo As ErrorInfo)
    ' セキュリティ特有のエラー処理をここに実装
    MsgBox "セキュリティエラーが発生しました。" & vbNewLine & _
           "エラー: " & errorInfo.Description, _
           vbCritical + vbOKOnly, _
           "セキュリティエラー"
End Sub

'*******************************************************************************
' 目的：    一般的なエラーの処理
' 引数：    errorInfo - エラー情報
' 戻り値：  なし
'*******************************************************************************
Private Sub HandleGeneralError(ByRef errorInfo As ErrorInfo)
    ' 一般的なエラー処理をここに実装
    MsgBox "エラーが発生しました。" & vbNewLine & _
           "エラー: " & errorInfo.Description, _
           vbCritical + vbOKOnly, _
           "エラー"
End Sub
```

## File: src/system/modLogger.bas
```
Attribute VB_Name = "modLogger"
Option Explicit

'*******************************************************************************
' モジュール: modLogger
' 目的：     システム全体のログ管理
' 作成日：   2025/01/17
'*******************************************************************************

' ログレベルの定義
Public Enum LogLevel
    llDebug = 1
    llInfo = 2
    llWarning = 3
    llError = 4
    llCritical = 5
End Enum

' ログ設定
Private Type LogConfig
    LogPath As String
    MinLogLevel As LogLevel
    MaxFileSize As Long
    RotateCount As Integer
    EnableConsole As Boolean
End Type

' デフォルト設定
Private Const DEFAULT_LOG_PATH As String = "app.log"
Private Const DEFAULT_MAX_FILE_SIZE As Long = 5242880 ' 5MB
Private Const DEFAULT_ROTATE_COUNT As Integer = 5
Private Const DEFAULT_MIN_LOG_LEVEL As LogLevel = llInfo

' 現在の設定
Private mConfig As LogConfig

'*******************************************************************************
' 目的：    モジュールの初期化
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Public Sub Initialize()
    ' デフォルト設定の適用
    With mConfig
        .LogPath = DEFAULT_LOG_PATH
        .MinLogLevel = DEFAULT_MIN_LOG_LEVEL
        .MaxFileSize = DEFAULT_MAX_FILE_SIZE
        .RotateCount = DEFAULT_ROTATE_COUNT
        .EnableConsole = True
    End With
End Sub

'*******************************************************************************
' 目的：    ログ設定の更新
' 引数：    logPath - ログファイルのパス
'           minLevel - 最小ログレベル
'           maxSize - 最大ファイルサイズ
'           rotateCount - ローテーション数
'           enableConsole - コンソール出力の有効化
' 戻り値：  なし
'*******************************************************************************
Public Sub Configure(Optional ByVal logPath As String = "", _
                    Optional ByVal minLevel As LogLevel = llInfo, _
                    Optional ByVal maxSize As Long = -1, _
                    Optional ByVal rotateCount As Integer = -1, _
                    Optional ByVal enableConsole As Boolean = True)
                    
    With mConfig
        If logPath <> "" Then .LogPath = logPath
        .MinLogLevel = minLevel
        If maxSize > 0 Then .MaxFileSize = maxSize
        If rotateCount > 0 Then .RotateCount = rotateCount
        .EnableConsole = enableConsole
    End With
End Sub

'*******************************************************************************
' 目的：    ログメッセージの記録
' 引数：    message - ログメッセージ
'           level - ログレベル
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub LogMessage(ByVal message As String, _
                     Optional ByVal level As LogLevel = llInfo, _
                     Optional ByVal source As String = "")
                     
    If level < mConfig.MinLogLevel Then Exit Sub
    
    Dim logEntry As String
    Dim timestamp As String
    
    ' タイムスタンプの生成
    timestamp = Format(Now, "yyyy-mm-dd hh:mm:ss")
    
    ' ログエントリの作成
    logEntry = timestamp & vbTab & _
              GetLogLevelName(level) & vbTab & _
              IIf(source <> "", source & vbTab, "") & _
              message
              
    ' ファイルへの書き込み
    WriteToLogFile logEntry
    
    ' コンソール出力
    If mConfig.EnableConsole Then
        Debug.Print logEntry
    End If
End Sub

'*******************************************************************************
' 目的：    デバッグログの記録
' 引数：    message - ログメッセージ
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub Debug(ByVal message As String, Optional ByVal source As String = "")
    LogMessage message, llDebug, source
End Sub

'*******************************************************************************
' 目的：    情報ログの記録
' 引数：    message - ログメッセージ
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub Info(ByVal message As String, Optional ByVal source As String = "")
    LogMessage message, llInfo, source
End Sub

'*******************************************************************************
' 目的：    警告ログの記録
' 引数：    message - ログメッセージ
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub Warning(ByVal message As String, Optional ByVal source As String = "")
    LogMessage message, llWarning, source
End Sub

'*******************************************************************************
' 目的：    エラーログの記録
' 引数：    message - ログメッセージ
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub Error(ByVal message As String, Optional ByVal source As String = "")
    LogMessage message, llError, source
End Sub

'*******************************************************************************
' 目的：    重大エラーログの記録
' 引数：    message - ログメッセージ
'           source - 発生源
' 戻り値：  なし
'*******************************************************************************
Public Sub Critical(ByVal message As String, Optional ByVal source As String = "")
    LogMessage message, llCritical, source
End Sub

'*******************************************************************************
' 目的：    ログレベル名の取得
' 引数：    level - ログレベル
' 戻り値：  ログレベルの文字列表現
'*******************************************************************************
Private Function GetLogLevelName(ByVal level As LogLevel) As String
    Select Case level
        Case llDebug
            GetLogLevelName = "DEBUG"
        Case llInfo
            GetLogLevelName = "INFO"
        Case llWarning
            GetLogLevelName = "WARNING"
        Case llError
            GetLogLevelName = "ERROR"
        Case llCritical
            GetLogLevelName = "CRITICAL"
        Case Else
            GetLogLevelName = "UNKNOWN"
    End Select
End Function

'*******************************************************************************
' 目的：    ログファイルへの書き込み
' 引数：    logEntry - ログエントリ
' 戻り値：  なし
'*******************************************************************************
Private Sub WriteToLogFile(ByVal logEntry As String)
    On Error Resume Next
    
    Dim fileNum As Integer
    
    ' ファイルサイズのチェックとローテーション
    CheckFileSize
    
    ' ログの書き込み
    fileNum = FreeFile
    Open mConfig.LogPath For Append As fileNum
    Print #fileNum, logEntry
    Close fileNum
End Sub

'*******************************************************************************
' 目的：    ログファイルのサイズチェックとローテーション
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Private Sub CheckFileSize()
    On Error Resume Next
    
    Dim fso As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' ファイルが存在し、サイズ制限を超えている場合
    If fso.FileExists(mConfig.LogPath) Then
        If fso.GetFile(mConfig.LogPath).Size >= mConfig.MaxFileSize Then
            RotateLogFiles
        End If
    End If
    
    Set fso = Nothing
End Sub

'*******************************************************************************
' 目的：    ログファイルのローテーション
' 引数：    なし
' 戻り値：  なし
'*******************************************************************************
Private Sub RotateLogFiles()
    On Error Resume Next
    
    Dim fso As Object
    Dim i As Integer
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    ' 最も古いログファイルの削除
    If fso.FileExists(mConfig.LogPath & "." & mConfig.RotateCount) Then
        fso.DeleteFile mConfig.LogPath & "." & mConfig.RotateCount
    End If
    
    ' ファイルの移動
    For i = mConfig.RotateCount - 1 To 1 Step -1
        If fso.FileExists(mConfig.LogPath & "." & i) Then
            fso.MoveFile mConfig.LogPath & "." & i, _
                        mConfig.LogPath & "." & (i + 1)
        End If
    Next i
    
    ' 現在のログファイルの移動
    If fso.FileExists(mConfig.LogPath) Then
        fso.MoveFile mConfig.LogPath, mConfig.LogPath & ".1"
    End If
    
    Set fso = Nothing
End Sub
```

## File: src/system/README.md
```markdown
# システム基盤層

このディレクトリには、アプリケーション全体の基盤となるシステムレベルのモジュールが含まれています。

## モジュール構成

### modErrorHandler.bas
エラー処理の中央管理システム。アプリケーション全体のエラーハンドリングを担当します。

```vb
' エラーハンドリングの使用例
Public Sub SomeFunction()
    On Error GoTo ErrorHandler
    ' 処理内容
    Exit Sub

ErrorHandler:
    modErrorHandler.HandleError Err.Number, _
                               Err.Description, _
                               "SomeModule.SomeFunction", _
                               etDatabase, _
                               "追加情報"
End Sub
```

### modLogger.bas
ログ管理システム。アプリケーションの動作ログを記録します。

```vb
' ログ出力の使用例
Public Sub ProcessData()
    ' モジュールの初期化
    modLogger.Initialize
    
    ' 各種ログレベルでの出力
    modLogger.Debug "デバッグ情報", "ProcessData"
    modLogger.Info "処理開始", "ProcessData"
    modLogger.Warning "警告メッセージ", "ProcessData"
    modLogger.Error "エラー発生", "ProcessData"
    modLogger.Critical "重大なエラー", "ProcessData"
End Sub
```

### modConfigManager.bas
設定管理システム。アプリケーションの設定を一元管理します。

```vb
' 設定管理の使用例
Public Sub InitializeApp()
    ' モジュールの初期化
    modConfigManager.Initialize "config/custom_settings.json"
    
    ' 設定値の取得
    Dim logLevel As String
    logLevel = modConfigManager.GetValue("logging", "level", "INFO")
    
    ' 設定値の更新
    modConfigManager.SetValue "logging", "level", "DEBUG"
End Sub
```

## モジュール間の連携

1. エラー処理とログ記録
```vb
Private Sub HandleDatabaseError(ByRef errorInfo As ErrorInfo)
    ' エラーをログに記録
    modLogger.Error errorInfo.Description, _
                    "Database Error: " & errorInfo.Source
    
    ' エラーメッセージを表示
    MsgBox "データベースエラーが発生しました。" & vbNewLine & _
           "詳細はログを確認してください。", _
           vbCritical + vbOKOnly, _
           "データベースエラー"
End Sub
```

2. 設定に基づくログレベルの制御
```vb
Public Sub ConfigureLogging()
    Dim logLevel As String
    Dim logPath As String
    
    ' 設定から値を取得
    logLevel = modConfigManager.GetValue("logging", "level", "INFO")
    logPath = modConfigManager.GetValue("logging", "path", "logs/app.log")
    
    ' ログ設定を更新
    modLogger.Configure logPath, _
                       GetLogLevelFromString(logLevel)
End Sub
```

## 初期化順序

システム基盤層のモジュールは以下の順序で初期化する必要があります：

1. 設定マネージャー（modConfigManager）
2. ログマネージャー（modLogger）
3. エラーハンドラー（modErrorHandler）

```vb
Public Sub InitializeSystem()
    ' 1. 設定の初期化
    modConfigManager.Initialize
    
    ' 2. ログの初期化（設定値を使用）
    modLogger.Initialize
    modLogger.Configure modConfigManager.GetValue("logging", "path"), _
                       modConfigManager.GetValue("logging", "level")
    
    ' 3. エラーハンドラーの準備は自動的に行われます
    
    ' 初期化完了のログ
    modLogger.Info "システム基盤層の初期化が完了しました。", "SystemInitialization"
End Sub
```

## エラーコード体系

システム基盤層で使用するエラーコードの範囲：

- vbObjectError + 513: 設定ファイル読み込みエラー
- vbObjectError + 514: デフォルト設定作成エラー
- vbObjectError + 515: 無効なセクション名エラー
- vbObjectError + 516: 設定値更新エラー
- vbObjectError + 517: 設定保存エラー

## 設定ファイル構造

```json
{
    "logging": {
        "level": "INFO",
        "path": "logs/app.log",
        "maxSize": 5242880,
        "rotateCount": 5
    },
    "database": {
        "server": "",
        "database": "",
        "username": "",
        "password": ""
    },
    "security": {
        "encryptionKey": "",
        "sessionTimeout": 30
    },
    "ui": {
        "theme": "default",
        "language": "ja"
    }
}
```

## セキュリティ考慮事項

1. 機密情報の取り扱い
   - パスワードなどの機密情報は暗号化して保存
   - ログにセンシティブな情報を出力しない
   - エラーメッセージは一般ユーザー向けに抽象化

2. エラー情報の制御
   - 本番環境では詳細なエラー情報を非表示
   - エラーログは適切なアクセス制御の下で管理
   - スタックトレースは開発環境でのみ表示

## 保守性とパフォーマンス

1. ログローテーション
   - ファイルサイズの制限
   - 古いログの自動アーカイブ
   - パフォーマンスへの影響を最小化

2. 設定のキャッシュ
   - メモリ内でのキャッシュ
   - 必要な場合のみファイルI/O
   - 変更監視による自動更新

## 今後の拡張計画

1. モジュールの追加
   - 国際化対応（modI18N）
   - キャッシュ管理（modCache）
   - メトリクス収集（modMetrics）

2. 機能強化
   - 非同期ログ出力
   - 設定の暗号化
   - リモート設定管理
```

## File: src/README.md
```markdown
# ソースコード

このディレクトリには本番環境で使用する実装コードを格納します。

## ディレクトリ構造

```
src/
├── data/          # データ層モジュール
│   ├── modDBHandler.bas       # データベース操作
│   ├── modFileSystem.bas      # ファイル操作
│   └── modDataValidator.bas   # データ検証
│
├── ui/            # UI層モジュール
│   ├── modUIController.bas    # UI制御
│   ├── modInputValidator.bas  # 入力検証
│   └── modFormFactory.bas     # フォーム生成
│
├── business/      # ビジネスロジック層
│   ├── modBusinessRules.bas   # ビジネスルール
│   ├── modWorkflowManager.bas # ワークフロー管理
│   └── modCalculator.bas      # 計算処理
│
├── utils/         # ユーティリティ層
│   ├── modStringHelper.bas    # 文字列操作
│   ├── modDateHelper.bas      # 日付処理
│   └── modArrayHelper.bas     # 配列操作
│
├── security/      # セキュリティ層
│   ├── modSecurity.bas        # セキュリティ機能
│   ├── modEncryption.bas      # 暗号化処理
│   └── modAccessControl.bas   # アクセス制御
│
└── system/        # システム基盤層
    ├── modErrorHandler.bas    # エラー処理
    ├── modLogger.bas          # ログ管理
    └── modConfigManager.bas   # 設定管理
```

## モジュール命名規則

- 標準モジュール: `mod〈機能名〉`
- クラスモジュール: `cls〈クラス名〉`
- フォーム: `frm〈画面名〉`

## 実装ガイドライン

1. レイヤー間の依存関係
   - UI層 → ビジネスロジック層 → データ層
   - すべての層 → ユーティリティ層
   - すべての層 → システム基盤層

2. モジュール設計原則
   - 単一責任の原則に従う
   - インターフェースを明確に定義
   - 実装の詳細はプライベート関数で隠蔽
   - 各モジュールは独立してテスト可能に

3. エラー処理とログ
   - すべてのパブリック関数でエラー処理を実装
   - エラーは`modErrorHandler`を通じて一元管理
   - 重要な操作は`modLogger`でログを記録

4. セキュリティ考慮事項
   - 機密データは`modEncryption`で暗号化
   - ユーザー権限は`modAccessControl`で管理
   - 入力値は必ず検証してから処理

5. 保守性と拡張性
   - コードは十分なコメントを付加
   - 設定値は`modConfigManager`で一元管理
   - 新機能追加時は該当する層に配置
```
